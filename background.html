<html>
<script>
chrome.extension.onRequest.addListener(
	function(message, sender, sendResponse) {
		console.log(sender.tab ? "from a content script:" + sender.tab.url : "from the extension");
		// if (message.action && sender.tab) {
		if (message.action && sender.tab) {
			switch (message.action) {
				case 'getFromLocalStorage':
					console.log('bg page says: ' + message.variableName + ': ' + localStorage [message.variableName]);
					if (localStorage[message.variableName] !== null) {
						console.log(localStorage[message.variableName]);
						sendResponse(localStorage[message.variableName]);
					}
					break;
			}
		}
	}
);

var selection_callbacks = [];
function getSelection(callback) {
	selection_callbacks.push(callback);
	chrome.tabs.executeScript(null, { file: "getSelection.js" });
};
// currently throwing an 'undefined is not an function' error
chrome.extension.onRequest.addListener(
	function(request, sender, sendResponse) {
		var callback = selection_callbacks.shift();
			callback(request);
	}
);

// Hacking my way through yet another localStorage retrieval, this time for use in popup.html
function getItem(key) {
	var value;
	//console.log('Get Item:' + key);
try {
	value = window.localStorage.getItem(key);
	if(value !== 'on') {
		value = "off";
	}	
}catch(e) {
	//console.log("Error inside getItem() for key:" + key);
	//console.log(e);
}
//console.log("Returning value: " + value);
	return value;
};

(function() {
	// Respond to messages passed from content script
	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			if (request.type === 'addDelicious') {
				addDelicious(request);
			}
		}
	);

	// Show delicious pop-up window
	addDelicious = function(conf) {
		var c = conf || {},
			doc = c.document || document,
			url = c.url || doc.location,
			title = c.title || doc.title,
			notes = c.notes || '',
			w = c.width || 550,
			h = c.height || 550,
			deliciousUrl = c.deliciousUrl || "http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url=",
			fullUrl;

		fullUrl = deliciousUrl + encodeURIComponent(url) + '&title=' + encodeURIComponent(title) + '&notes=' + encodeURIComponent(notes);

		window.open(
			fullUrl,
			'deliciousuiv5',
			'location=yes,links=no,scrollbars=no,toolbar=no,width=' + w.toString() + ',height=' + h.toString()
		);

	};

})();
</script>
</html>
